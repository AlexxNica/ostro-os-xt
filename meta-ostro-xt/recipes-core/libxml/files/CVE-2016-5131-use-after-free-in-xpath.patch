From e3edfa4fe989a90e9c768de88614de71538c8bb5 Mon Sep 17 00:00:00 2001
From: Ismo Puustinen <ismo.puustinen@intel.com>
Date: Wed, 7 Sep 2016 17:51:41 +0300
Subject: [PATCH] CVE-2016-5131: use after free in xpath.

CVE: CVE-2016-5131
Upstream-status: Backport (from Chromium's fork of libxml)

Original patch by dominicc, downloaded from here:
https://codereview.chromium.org/2127493002/patch/1/10002

Signed-off-by: Ismo Puustinen <ismo.puustinen@intel.com>
---
 xpath.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/xpath.c b/xpath.c
index 751665b..5465764 100644
--- a/xpath.c
+++ b/xpath.c
@@ -10691,14 +10691,17 @@ xmlXPathCompPathExpr(xmlXPathParserContextPtr ctxt) {
 		    lc = 1;
 		    break;
 		} else if ((NXT(len) == '(')) {
-		    /* Note Type or Function */
+		    /* Node Type or Function */
 		    if (xmlXPathIsNodeType(name)) {
 #ifdef DEBUG_STEP
 		        xmlGenericError(xmlGenericErrorContext,
 				"PathExpr: Type search\n");
 #endif
 			lc = 1;
-		    } else {
+		} else if (ctxt->xptr &&
+		           xmlStrEqual(name, BAD_CAST "range-to")) {
+		    lc = 1;
+		} else {
 #ifdef DEBUG_STEP
 		        xmlGenericError(xmlGenericErrorContext,
 				"PathExpr: function call\n");
-- 
2.7.4

